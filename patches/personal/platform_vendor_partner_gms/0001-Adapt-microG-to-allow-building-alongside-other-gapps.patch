From 144f4f7fdefd25f51003412e816157de01c7fd2c Mon Sep 17 00:00:00 2001
From: "Christopher A. Williamson" <home@chrisaw.com>
Date: Sun, 17 Mar 2024 12:57:28 +0000
Subject: [PATCH 1/1] Adapt microG to allow building alongside other gapps sources

---
 FDroid/Android.mk                    | 26 ++++++-----
 FDroidPrivilegedExtension/Android.mk | 20 --------
 FakeStore/Android.mk                 | 48 ++++++++++---------
 GmsCore/Android.mk                   | 70 ++++++++++++++--------------
 GsfProxy/Android.mk                  | 20 ++++----
 NominatimGeocoderBackend/Android.mk  | 20 ++++----
 additional_repos.xml/Android.mk      | 16 ++++---
 products/gms.mk                      | 19 ++++----
 8 files changed, 116 insertions(+), 123 deletions(-)
 delete mode 100644 FDroidPrivilegedExtension/Android.mk

diff --git a/FDroid/Android.mk b/FDroid/Android.mk
index 3f0430a..92e5a44 100644
--- a/FDroid/Android.mk
+++ b/FDroid/Android.mk
@@ -1,13 +1,15 @@
-LOCAL_PATH := $(call my-dir)
-include $(CLEAR_VARS)
-LOCAL_MODULE := FDroid
-LOCAL_SRC_FILES := FDroid.apk
-LOCAL_MODULE_CLASS := APPS
-LOCAL_MODULE_SUFFIX := $(COMMON_ANDROID_PACKAGE_SUFFIX)
-LOCAL_CERTIFICATE := PRESIGNED
-# these lines may break builds before 19.1 so make them conditional
-ifneq ($(call math_gt_or_eq, $(PLATFORM_SDK_VERSION), 31),)
-LOCAL_OPTIONAL_USES_LIBRARIES := androidx.window.extensions androidx.window.sidecar
+ifeq ($(WITH_MICROG),true)
+  LOCAL_PATH := $(call my-dir)
+  include $(CLEAR_VARS)
+  LOCAL_MODULE := FDroid
+  LOCAL_SRC_FILES := FDroid.apk
+  LOCAL_MODULE_CLASS := APPS
+  LOCAL_MODULE_SUFFIX := $(COMMON_ANDROID_PACKAGE_SUFFIX)
+  LOCAL_CERTIFICATE := PRESIGNED
+  # these lines may break builds before 19.1 so make them conditional
+  ifneq ($(call math_gt_or_eq, $(PLATFORM_SDK_VERSION), 31),)
+  LOCAL_OPTIONAL_USES_LIBRARIES := androidx.window.extensions androidx.window.sidecar
+  endif
+  LOCAL_PRODUCT_MODULE := true
+  include $(BUILD_PREBUILT)
 endif
-LOCAL_PRODUCT_MODULE := true
-include $(BUILD_PREBUILT)
diff --git a/FDroidPrivilegedExtension/Android.mk b/FDroidPrivilegedExtension/Android.mk
deleted file mode 100644
index 3c0cd63..0000000
--- a/FDroidPrivilegedExtension/Android.mk
+++ /dev/null
@@ -1,20 +0,0 @@
-LOCAL_PATH := $(call my-dir)
-
-include $(CLEAR_VARS)
-LOCAL_MODULE := privapp-permissions-org.fdroid.fdroid.privileged.xml
-LOCAL_MODULE_CLASS := ETC
-LOCAL_MODULE_PATH := $(TARGET_OUT_PRODUCT_ETC)/permissions
-LOCAL_SRC_FILES := $(LOCAL_MODULE)
-include $(BUILD_PREBUILT)
-
-include $(CLEAR_VARS)
-LOCAL_MODULE := FDroidPrivilegedExtension
-LOCAL_SRC_FILES := FDroidPrivilegedExtension.apk
-LOCAL_MODULE_CLASS := APPS
-LOCAL_PRIVILEGED_MODULE := true
-LOCAL_MODULE_SUFFIX := $(COMMON_ANDROID_PACKAGE_SUFFIX)
-LOCAL_CERTIFICATE := PRESIGNED
-LOCAL_REQUIRED_MODULES := privapp-permissions-org.fdroid.fdroid.privileged.xml
-LOCAL_PRODUCT_MODULE := true
-include $(BUILD_PREBUILT)
-
diff --git a/FakeStore/Android.mk b/FakeStore/Android.mk
index 63907ba..3f0a96a 100644
--- a/FakeStore/Android.mk
+++ b/FakeStore/Android.mk
@@ -1,27 +1,29 @@
-LOCAL_PATH := $(call my-dir)
+ifeq ($(WITH_MICROG),true)
+  LOCAL_PATH := $(call my-dir)
 
-include $(CLEAR_VARS)
-LOCAL_MODULE := privapp-permissions-com.android.vending.xml
-LOCAL_MODULE_CLASS := ETC
-LOCAL_MODULE_PATH := $(TARGET_OUT_PRODUCT_ETC)/permissions
-LOCAL_SRC_FILES := $(LOCAL_MODULE)
-include $(BUILD_PREBUILT)
+  include $(CLEAR_VARS)
+  LOCAL_MODULE := privapp-permissions-com.android.vending.xml
+  LOCAL_MODULE_CLASS := ETC
+  LOCAL_MODULE_PATH := $(TARGET_OUT_PRODUCT_ETC)/permissions
+  LOCAL_SRC_FILES := $(LOCAL_MODULE)
+  include $(BUILD_PREBUILT)
 
-include $(CLEAR_VARS)
-LOCAL_MODULE := default-permissions-com.android.vending.xml
-LOCAL_MODULE_CLASS := ETC
-LOCAL_MODULE_PATH := $(TARGET_OUT_PRODUCT_ETC)/default-permissions
-LOCAL_SRC_FILES := $(LOCAL_MODULE)
-include $(BUILD_PREBUILT)
+  include $(CLEAR_VARS)
+  LOCAL_MODULE := default-permissions-com.android.vending.xml
+  LOCAL_MODULE_CLASS := ETC
+  LOCAL_MODULE_PATH := $(TARGET_OUT_PRODUCT_ETC)/default-permissions
+  LOCAL_SRC_FILES := $(LOCAL_MODULE)
+  include $(BUILD_PREBUILT)
 
-include $(CLEAR_VARS)
-LOCAL_MODULE := FakeStore
-LOCAL_SRC_FILES := FakeStore.apk
-LOCAL_MODULE_CLASS := APPS
-LOCAL_PRIVILEGED_MODULE := true
-LOCAL_MODULE_SUFFIX := $(COMMON_ANDROID_PACKAGE_SUFFIX)
-LOCAL_CERTIFICATE := PRESIGNED
-LOCAL_REQUIRED_MODULES := privapp-permissions-com.android.vending.xml default-permissions-com.android.vending.xml
-LOCAL_PRODUCT_MODULE := true
-include $(BUILD_PREBUILT)
+  include $(CLEAR_VARS)
+  LOCAL_MODULE := FakeStore
+  LOCAL_SRC_FILES := FakeStore.apk
+  LOCAL_MODULE_CLASS := APPS
+  LOCAL_PRIVILEGED_MODULE := true
+  LOCAL_MODULE_SUFFIX := $(COMMON_ANDROID_PACKAGE_SUFFIX)
+  LOCAL_CERTIFICATE := PRESIGNED
+  LOCAL_REQUIRED_MODULES := privapp-permissions-com.android.vending.xml default-permissions-com.android.vending.xml
+  LOCAL_PRODUCT_MODULE := true
+  include $(BUILD_PREBUILT)
+endif
 
diff --git a/GmsCore/Android.mk b/GmsCore/Android.mk
index 34bc76e..6bf461a 100644
--- a/GmsCore/Android.mk
+++ b/GmsCore/Android.mk
@@ -1,39 +1,41 @@
-LOCAL_PATH := $(call my-dir)
+ifeq ($(WITH_MICROG),true)
+  LOCAL_PATH := $(call my-dir)
 
-include $(CLEAR_VARS)
-LOCAL_MODULE := privapp-permissions-com.google.android.gms.xml
-LOCAL_MODULE_CLASS := ETC
-LOCAL_MODULE_PATH := $(TARGET_OUT_PRODUCT_ETC)/permissions
-LOCAL_SRC_FILES := $(LOCAL_MODULE)
-include $(BUILD_PREBUILT)
+  include $(CLEAR_VARS)
+  LOCAL_MODULE := privapp-permissions-com.google.android.gms.xml
+  LOCAL_MODULE_CLASS := ETC
+  LOCAL_MODULE_PATH := $(TARGET_OUT_PRODUCT_ETC)/permissions
+  LOCAL_SRC_FILES := $(LOCAL_MODULE)
+  include $(BUILD_PREBUILT)
 
-include $(CLEAR_VARS)
-LOCAL_MODULE := default-permissions-com.google.android.gms.xml
-LOCAL_MODULE_CLASS := ETC
-LOCAL_MODULE_PATH := $(TARGET_OUT_PRODUCT_ETC)/default-permissions
-LOCAL_SRC_FILES := $(LOCAL_MODULE)
-include $(BUILD_PREBUILT)
+  include $(CLEAR_VARS)
+  LOCAL_MODULE := default-permissions-com.google.android.gms.xml
+  LOCAL_MODULE_CLASS := ETC
+  LOCAL_MODULE_PATH := $(TARGET_OUT_PRODUCT_ETC)/default-permissions
+  LOCAL_SRC_FILES := $(LOCAL_MODULE)
+  include $(BUILD_PREBUILT)
 
-include $(CLEAR_VARS)
-LOCAL_MODULE := sysconfig-com.google.android.gms.xml
-LOCAL_MODULE_CLASS := ETC
-LOCAL_MODULE_PATH := $(TARGET_OUT_PRODUCT_ETC)/sysconfig
-LOCAL_SRC_FILES := $(LOCAL_MODULE)
-include $(BUILD_PREBUILT)
+  include $(CLEAR_VARS)
+  LOCAL_MODULE := sysconfig-com.google.android.gms.xml
+  LOCAL_MODULE_CLASS := ETC
+  LOCAL_MODULE_PATH := $(TARGET_OUT_PRODUCT_ETC)/sysconfig
+  LOCAL_SRC_FILES := $(LOCAL_MODULE)
+  include $(BUILD_PREBUILT)
 
-include $(CLEAR_VARS)
-LOCAL_MODULE := GmsCore
-LOCAL_SRC_FILES := GmsCore.apk
-LOCAL_MODULE_CLASS := APPS
-LOCAL_PRIVILEGED_MODULE := true
-LOCAL_MODULE_SUFFIX := $(COMMON_ANDROID_PACKAGE_SUFFIX)
-LOCAL_CERTIFICATE := PRESIGNED
-LOCAL_OVERRIDES_PACKAGES := com.qualcomm.location
-LOCAL_REQUIRED_MODULES := privapp-permissions-com.google.android.gms.xml default-permissions-com.google.android.gms.xml sysconfig-com.google.android.gms.xml
-# these lines will break builds before 19.1 so make them conditional
-ifneq ($(call math_gt_or_eq, $(PLATFORM_SDK_VERSION), 31),)
-LOCAL_USES_LIBRARIES := com.android.location.provider
-LOCAL_OPTIONAL_USES_LIBRARIES := org.apache.http.legacy androidx.window.extensions androidx.window.sidecar
+  include $(CLEAR_VARS)
+  LOCAL_MODULE := GmsCore
+  LOCAL_SRC_FILES := GmsCore.apk
+  LOCAL_MODULE_CLASS := APPS
+  LOCAL_PRIVILEGED_MODULE := true
+  LOCAL_MODULE_SUFFIX := $(COMMON_ANDROID_PACKAGE_SUFFIX)
+  LOCAL_CERTIFICATE := PRESIGNED
+  LOCAL_OVERRIDES_PACKAGES := com.qualcomm.location
+  LOCAL_REQUIRED_MODULES := privapp-permissions-com.google.android.gms.xml default-permissions-com.google.android.gms.xml sysconfig-com.google.android.gms.xml
+  # these lines will break builds before 19.1 so make them conditional
+  ifneq ($(call math_gt_or_eq, $(PLATFORM_SDK_VERSION), 31),)
+  LOCAL_USES_LIBRARIES := com.android.location.provider
+  LOCAL_OPTIONAL_USES_LIBRARIES := org.apache.http.legacy androidx.window.extensions androidx.window.sidecar
+  endif
+  LOCAL_PRODUCT_MODULE := true
+  include $(BUILD_PREBUILT)
 endif
-LOCAL_PRODUCT_MODULE := true
-include $(BUILD_PREBUILT)
diff --git a/GsfProxy/Android.mk b/GsfProxy/Android.mk
index 248d922..316ef84 100644
--- a/GsfProxy/Android.mk
+++ b/GsfProxy/Android.mk
@@ -1,9 +1,11 @@
-LOCAL_PATH := $(call my-dir)
-include $(CLEAR_VARS)
-LOCAL_MODULE := GsfProxy
-LOCAL_SRC_FILES := GsfProxy.apk
-LOCAL_MODULE_CLASS := APPS
-LOCAL_MODULE_SUFFIX := $(COMMON_ANDROID_PACKAGE_SUFFIX)
-LOCAL_CERTIFICATE := PRESIGNED
-LOCAL_PRODUCT_MODULE := true
-include $(BUILD_PREBUILT)
+ifeq ($(WITH_MICROG),true)
+  LOCAL_PATH := $(call my-dir)
+  include $(CLEAR_VARS)
+  LOCAL_MODULE := GsfProxy
+  LOCAL_SRC_FILES := GsfProxy.apk
+  LOCAL_MODULE_CLASS := APPS
+  LOCAL_MODULE_SUFFIX := $(COMMON_ANDROID_PACKAGE_SUFFIX)
+  LOCAL_CERTIFICATE := PRESIGNED
+  LOCAL_PRODUCT_MODULE := true
+  include $(BUILD_PREBUILT)
+endif
diff --git a/NominatimGeocoderBackend/Android.mk b/NominatimGeocoderBackend/Android.mk
index 1689d20..ccfe5aa 100644
--- a/NominatimGeocoderBackend/Android.mk
+++ b/NominatimGeocoderBackend/Android.mk
@@ -1,9 +1,11 @@
-LOCAL_PATH := $(call my-dir)
-include $(CLEAR_VARS)
-LOCAL_MODULE := NominatimGeocoderBackend
-LOCAL_SRC_FILES := NominatimGeocoderBackend.apk
-LOCAL_MODULE_CLASS := APPS
-LOCAL_MODULE_SUFFIX := $(COMMON_ANDROID_PACKAGE_SUFFIX)
-LOCAL_CERTIFICATE := PRESIGNED
-LOCAL_PRODUCT_MODULE := true
-include $(BUILD_PREBUILT)
+ifeq ($(WITH_MICROG),true)
+  LOCAL_PATH := $(call my-dir)
+  include $(CLEAR_VARS)
+  LOCAL_MODULE := NominatimGeocoderBackend
+  LOCAL_SRC_FILES := NominatimGeocoderBackend.apk
+  LOCAL_MODULE_CLASS := APPS
+  LOCAL_MODULE_SUFFIX := $(COMMON_ANDROID_PACKAGE_SUFFIX)
+  LOCAL_CERTIFICATE := PRESIGNED
+  LOCAL_PRODUCT_MODULE := true
+  include $(BUILD_PREBUILT)
+endif
diff --git a/additional_repos.xml/Android.mk b/additional_repos.xml/Android.mk
index 87892d4..cf43e00 100644
--- a/additional_repos.xml/Android.mk
+++ b/additional_repos.xml/Android.mk
@@ -1,9 +1,11 @@
-LOCAL_PATH := $(call my-dir)
+ifeq ($(WITH_MICROG),true)
+  LOCAL_PATH := $(call my-dir)
 
-include $(CLEAR_VARS)
-LOCAL_MODULE := additional_repos.xml
-LOCAL_MODULE_CLASS := ETC
-LOCAL_MODULE_PATH := $(TARGET_OUT_PRODUCT_ETC)/org.fdroid.fdroid
-LOCAL_SRC_FILES := additional_repos.xml
-include $(BUILD_PREBUILT)
+  include $(CLEAR_VARS)
+  LOCAL_MODULE := additional_repos.xml
+  LOCAL_MODULE_CLASS := ETC
+  LOCAL_MODULE_PATH := $(TARGET_OUT_PRODUCT_ETC)/org.fdroid.fdroid
+  LOCAL_SRC_FILES := additional_repos.xml
+  include $(BUILD_PREBUILT)
+endif
 
diff --git a/products/gms.mk b/products/gms.mk
index dfbd889..cf73093 100644
--- a/products/gms.mk
+++ b/products/gms.mk
@@ -1,9 +1,10 @@
-PRODUCT_PACKAGES += \
-	GmsCore \
-	GsfProxy \
-	FakeStore \
-	IchnaeaNlpBackend \
-	NominatimGeocoderBackend \
-	FDroid \
-	FDroidPrivilegedExtension \
-	additional_repos.xml
+ifeq ($(WITH_MICROG),true)
+  PRODUCT_PACKAGES += \
+    MicroGmsCore \
+    GsfProxy \
+    FakeStore \
+    IchnaeaNlpBackend \
+    NominatimGeocoderBackend \
+    FDroid \
+    additional_repos.xml
+endif
-- 
2.43.2
