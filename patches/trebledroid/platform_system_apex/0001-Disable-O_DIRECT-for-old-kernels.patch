From 5cea503e63b91024670a641c1ff02227113853db Mon Sep 17 00:00:00 2001
From: Pierre-Hugues Husson <phh@phh.me>
Date: Tue, 7 May 2024 19:28:41 -0400
Subject: [PATCH] Disable O_DIRECT for old kernels

On old kernels, mounting over O_DIRECT over FBE ext4 leads to corrupted
reads.
"Old kernel" is hard to define, some 4.19 and 4.14 got the fix.
The penalty for not using o_direct is a bit of performance/ram hit, so
live with it

Co-authored-by: Alberto Ponces <ponces26@gmail.com>
Change-Id: I710e870bc467000547b00958b0818aaf0ddca072
---
 apexd/apexd_loop.cpp | 17 ++++++++++++++++-
 1 file changed, 16 insertions(+), 1 deletion(-)

diff --git a/apexd/apexd_loop.cpp b/apexd/apexd_loop.cpp
index 568eb055..d8c660b7 100644
--- a/apexd/apexd_loop.cpp
+++ b/apexd/apexd_loop.cpp
@@ -23,10 +23,11 @@
 #include <linux/fs.h>
 #include <linux/loop.h>
 #include <sys/ioctl.h>
 #include <sys/stat.h>
 #include <sys/types.h>
+#include <sys/utsname.h>
 #include <unistd.h>
 
 #include <android-base/file.h>
 #include <android-base/logging.h>
 #include <android-base/stringprintf.h>
@@ -147,11 +148,25 @@ Result<LoopbackDeviceUniqueFd> createLoopDevice(const std::string& target,
    * size of the underlying block device may not match the default loop
    * device block size (512); when we call LOOP_SET_BLOCK_SIZE below, the
    * kernel driver will automatically enable Direct I/O when it sees that
    * condition is now met.
    */
-  unique_fd target_fd(open(target.c_str(), O_RDONLY | O_CLOEXEC | O_DIRECT));
+  bool enable_odirect = false;
+  struct utsname uts;
+  unsigned int major, minor;
+  if (uname(&uts) == 0 && sscanf(uts.release, "%u.%u", &major, &minor) == 2) {
+    if(major > 4) enable_odirect = true;
+    if(major == 4 && minor > 19) enable_odirect = true;
+  }
+  unique_fd target_fd;
+  if (enable_odirect) {
+    target_fd = unique_fd(open(target.c_str(), O_RDONLY | O_CLOEXEC | O_DIRECT));
+  } else {
+    target_fd = unique_fd(open(target.c_str(), O_RDONLY | O_CLOEXEC));
+  }
+  //unique_fd target_fd(open(target.c_str(), O_RDONLY | O_CLOEXEC));
+
   if (target_fd.get() == -1) {
     return ErrnoError() << "Failed to open " << target;
   }
   LoopbackDeviceUniqueFd device_fd;
   {
-- 
2.45.1
